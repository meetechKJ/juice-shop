name: ZAP Security Scan (Docker Version)

# Dockerを使用したより安定版のZAPスキャン
on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  zap-scan-docker:
    runs-on: ubuntu-latest
    name: ZAP Full Scan with Docker
    
    steps:
    # 1. ソースコードをチェックアウト
    - name: Checkout code
      uses: actions/checkout@v4
    
    # 2. Dockerを使ってjuice-shopを起動
    - name: Build and Start Juice Shop with Docker
      run: |
        # Dockerイメージをビルド
        docker build -t juice-shop .
        # コンテナをバックグラウンドで起動
        docker run -d -p 3000:3000 --name juice-shop juice-shop
        echo "Waiting for application to start..."
        sleep 30
        
        # アプリケーションが起動しているか確認
        for i in {1..10}; do
          if curl -f http://localhost:3000; then
            echo "Application is running"
            break
          else
            echo "Attempt $i: Application not ready yet, waiting..."
            sleep 10
          fi
        done
    
    # 3. ZAP Baseline Scan（軽量スキャン）
    - name: ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: 'http://localhost:3000'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
    
    # 4. ZAP Full Scan（完全スキャン）
    - name: ZAP Full Scan
      uses: zaproxy/action-full-scan@v0.10.0
      with:
        target: 'http://localhost:3000'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a -j'
    
    # 5. スキャン結果をアーティファクトとして保存
    - name: Upload ZAP scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-scan-results-docker
        path: |
          report_html.html
          report_json.json
          report_md.md
        retention-days: 30
    
    # 6. クリーンアップ
    - name: Cleanup Docker containers
      if: always()
      run: |
        docker stop juice-shop || true
        docker rm juice-shop || true

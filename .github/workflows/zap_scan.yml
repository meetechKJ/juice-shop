name: ZAP Security Scan - Fixed

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    name: ZAP Security Scan
    
    # æ¨©é™ã‚’æ˜ç¤ºçš„ã«è¨­å®šï¼ˆIssueä½œæˆã‚’ç„¡åŠ¹åŒ–ï¼‰
    permissions:
      contents: read
      actions: read
      
    steps:
    # 1. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. Node.jsç’°å¢ƒã®æº–å‚™
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '14'
        cache: 'npm'
    
    # 3. ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dependencies
      run: |
        npm ci --legacy-peer-deps
        cd frontend && npm install --legacy-peer-deps && cd ..
    
    # 4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦èµ·å‹•
    - name: Build and Start Juice Shop
      run: |
        npm run build
        npm start &
        echo "Waiting for application to start..."
        sleep 60
        
        # èµ·å‹•ç¢ºèªï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
        for i in {1..5}; do
          if curl -f http://localhost:3000; then
            echo "Application is running successfully"
            break
          else
            echo "Attempt $i: Application not ready, waiting..."
            sleep 15
            if [ $i -eq 5 ]; then
              echo "Application failed to start"
              exit 1
            fi
          fi
        done
    
    # 5. ã‚¹ã‚­ãƒ£ãƒ³çµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆï¼ˆæ¨©é™å•é¡Œã‚’å›é¿ï¼‰
    - name: Prepare scan directories
      run: |
        mkdir -p zap-reports
        chmod 777 zap-reports
    
    # 6. ZAP Baseline Scanï¼ˆIssueä½œæˆã‚’ç„¡åŠ¹åŒ–ï¼‰
    - name: ZAP Baseline Scan
      continue-on-error: true
      run: |
        docker run -v $(pwd)/zap-reports:/zap/wrk/:rw \
          --network=host \
          -t ghcr.io/zaproxy/zaproxy:stable \
          zap-baseline.py \
          -t http://localhost:3000 \
          -J zap-baseline-report.json \
          -w zap-baseline-report.md \
          -r zap-baseline-report.html \
          -a \
          --hook=/zap/auth_hook.py || true
    
    # 7. ZAP Full Scanï¼ˆIssueä½œæˆã‚’ç„¡åŠ¹åŒ–ï¼‰
    - name: ZAP Full Scan
      continue-on-error: true
      run: |
        docker run -v $(pwd)/zap-reports:/zap/wrk/:rw \
          --network=host \
          -t ghcr.io/zaproxy/zaproxy:stable \
          zap-full-scan.py \
          -t http://localhost:3000 \
          -J zap-full-report.json \
          -w zap-full-report.md \
          -r zap-full-report.html \
          -a \
          -j || true
    
    # 8. ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
    - name: Upload ZAP scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-security-scan-results
        path: |
          zap-reports/
        retention-days: 30
    
    # 9. ã‚¹ã‚­ãƒ£ãƒ³çµæœã®ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
    - name: Display Scan Summary
      if: always()
      run: |
        echo "=== ZAP Scan Summary ==="
        if [ -f "zap-reports/zap-baseline-report.json" ]; then
          echo "âœ… Baseline scan completed"
          # JSONã‹ã‚‰é‡è¦ãªæƒ…å ±ã‚’æŠ½å‡º
          if command -v jq &> /dev/null; then
            echo "High risk alerts: $(jq '.site[].alerts[] | select(.riskdesc=="High") | length' zap-reports/zap-baseline-report.json 2>/dev/null || echo "0")"
            echo "Medium risk alerts: $(jq '.site[].alerts[] | select(.riskdesc=="Medium") | length' zap-reports/zap-baseline-report.json 2>/dev/null || echo "0")"
          fi
        else
          echo "âŒ Baseline scan failed or incomplete"
        fi
        
        if [ -f "zap-reports/zap-full-report.json" ]; then
          echo "âœ… Full scan completed"
        else
          echo "âŒ Full scan failed or incomplete"
        fi
        
        echo "ğŸ“„ Reports available in artifacts section"
    
    # 10. é‡è¦ãªè„†å¼±æ€§ãŒã‚ã£ãŸå ´åˆã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    - name: Check for High Risk Vulnerabilities
      if: always()
      run: |
        if [ -f "zap-reports/zap-baseline-report.json" ] || [ -f "zap-reports/zap-full-report.json" ]; then
          echo "::notice::ZAP security scan completed. Check the artifacts for detailed reports."
        else
          echo "::warning::ZAP scan may have encountered issues. Please check the logs."
        fi
